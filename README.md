# MikrotikBlockDangerAddresses - скрипт блокировки опасных IP-адресов, с которых пытались произвести подключение к роутеру.

Листая журналы Mikrotik-ов, мое внимание привлекли настойчивые попытки подключиться к моим роутерам, подобные таким:

```
Mmm/dd/yyyy hh:mm:ss disk system, error, critical login failure for user system from xxx.xxx.xxx.xxx via api
```

Было решено автоматизировать процесс нейтрализации всех попыток завладеть моими устройствами. Получился скрипт, который необходимо запускать по расписанию с нужной периодичностью.
Результатом работы скрипта является создание черного списка адресов, в который складываются все IP-адреса, с которых были обнаружены попытки несанкционированного доступа к роутеру, такие как:

- залогиниться на роутер с несуществующим именем роутера (строка в журнале: '**login failure for user XXXXXXX**'),
- залогиниться на роутер из непрописанной сети (строка в журнале: '**denied winbox/dude connect from**')
- подобрать пароль IPSec (строка в журнале: '**parsing packet failed, possible cause: wrong password**'),
- подключиться по IPSec c несовпадающим предложением (строка в журнале: '**failed to get valid proposal'**'),
- подобрать пароль L2TP (строка в журнале: '**user XXXXXXX authentication failed**'),
- подобрать пароль PPTP (строка в журнале: '**user XXXXXXX authentication failed**'),
- подключиться по OVPN с несовпадающими данными (строка в журнале: '**unknown msg**' или '**msg too short**'),

Попутно скрипт автоматически добавляет правило в Firewall/Filter Rules, нейтрализующее все попытки подключения к роутеру с выявленных IP-адресов:

```
/ip firewall filter add action=drop chain=input comment="Dropping dangerous adresses" src-address-list=BlockDangerAddress
```

https://forummikrotik.ru/viewtopic.php?f=14&t=11586

***Как это работает:***

Чёрный список адресов формируется скриптом автоматически в ходе периодического анализа журнала устройства. Анализ журнала производится в несколько шагов:

1. шаг
   - В журнале выискиваются строки, указывающие на неудачную попытку залогиниться на роутер
   - Из каждой найденной строки вычленяется login и ip-адрес, с которого пытались залогиниться
   - Полученный login проверяется на предмет отсутствия в списке имен активных пользователей Mikrotik-а (такого user-а не существует)
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.

2. шаг
   - В журнале выискиваются строки, указывающие на попытку подключения из непрописанной сети
   - Из каждой найденной строки вычленяется ip-адрес, с которого производилась попытка подключения
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.

3. шаг
   - В журнале выискиваются строки, указывающие на неудачную попытку подобрать пароль IPSec
   - Из каждой найденной строки вычленяется ip-адрес, с которого пытались подобрать пароль IPSec
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.

4. шаг
   - В журнале выискиваются строки, указывающие на неудачное предложение IPSec
   - Из каждой найденной строки вычленяется ip-адрес, с которого пытались подобрать предложение IPSec
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.

5. шаг
   - В журнале выискиваются строки, указывающие на неудачную аутентификацию по L2TP
   - Из каждой найденной строки вычленяется ip-адрес, с которого производилась неудачная аутентификация по L2TP
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.

6. шаг
   - В журнале выискиваются строки, указывающие на неудачную аутентификацию по PPTP
   - Из каждой найденной строки вычленяется ip-адрес, с которого производилась неудачная аутентификация по PPTP
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.

7. шаг
   - В журнале выискиваются строки, указывающие на неудачную аутентификацию по OVPN
   - Из каждой найденной строки вычленяется ip-адрес, с которого производилась неудачная аутентификация по PPTP
   - Полученный ip-адрес проверяется на наличие в черном списке. Если его там нет, тогда добавляется в черный список.
------


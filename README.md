# Cкрипт блокировки опасных IPv4 адресов, с которых пытались произвести подключение к роутеру.

Скрипт автоматически блокирует IPv4 адреса злоумышленников, прощупывающих маршрутизаторы Mikrotik из внешних сетей. Скрипт не имеет зависимостей от сторонних функций и скриптов. Настройка подразумевает правку значений локальных переменных в начале тела скрипта, краткое описание которых присутствует в комментариях. Тело скрипта необходимо закинуть в 'System/Scripts', запустить вручную из окна терминала командой '/system script run <имя скрипта>', ознакомиться с представленной информацией и при необходимости подправить рабочие настройки. Далее производится настройка запуска по расписанию из 'System/Scheduler' с необходимым периодом времени (типовое значение составляет единицы минут).

Работа скрипта сводится к формированию чёрного списка IPv4 адресов для их блокировки.
Формирование чёрного списка происходит двумя разными независимыми способами:
  1. на основе анализа записей журнала устройства
  2. при помощи преднастроенных правил Firewall

1й способ срабатывает каждый раз при запуске скрипта. При первом запуске проверяется весь журнал устройства, а при последующих запусках проверяется только непроверенная часть журнала. Так сделано для увеличения скорости последующих проверок журнала. 

2й способ изначально отключен, это сделано из соображения, что Firewall может быть уже настроен и вмешательство в его работу не желательно.
Активация 2го способа производится вручную, путём присвоения переменной 'fwUsag' значения 'true'.
После активации 2го способа скрипт настраивает Firewall по принципу: "запрещено всё, что не разрешено" и с этого момента, даже если скрипт не запущен, все попытки из вне прощупать роутер будут считаться несанкционированными.
Попутно, при задействовании 2го способа, при каждом запуске скрипт проверяет наличие преднастроенных правил Firewall и в случае их отсутствия производит установку недостающих. Поиск недостающих правил Firewall скрипт производит по комментариям в списках: 'Firewall/Filter Rules', 'Firewall/Raw', 'Firewall/Layer7 Protocols'. После установки правил Firewall пользователю необходимо расположить их вручную согласно своим предпочтениям. Для исключения неожиданной блокировки при установке новых правил, правила блокировки устанавливаются ОТКЛЮЧЕННЫМИ (!!!). Перемещение и активацию правил блокировки пользователь делает самостоятельно, вручную. Настройка правил FIREWALL производится в активном режиме 'Safe Mode' на случай неожиданной потери связи с роутером и для автоматического отката настроек в исходное состояние. По окончании настроек режим 'Safe Mode' необходимо деактивировать. Если правила блокировки оставить отключенными - скрипт будет об этом оповещать.

В итоге, все обращения к роутеру, не прошедшие проверку Firewall или отображённые в журнале устройства, как попытки несанкционированного доступа, попадают в черный список и блокируются на время, заданное в переменной 'timeout'. Типовое количество записей в чёрном списке при блокировке на 8 часов может составлять от нескольких сотен до нескольких тысяч (!!!) записей, и напрямую зависит от активности злоумышленников.

Обкатка скрипта проводилась на актуальных версиях RouterOS 6.49.++ и 7.16.++ .

Известные проблемы:
* работа скрипта может завершаться ошибкой, при включенном контроле правил Firewall и наличии в списке одинаковых правил с отличающимися комментариями.
* для предотвращения блокировки скриптом адресов, влияющих на работоспособность сетевого оборудования (DNS провайдера, адрес вышестоящего узла и т.п.), имеет смысл заранее внести их в белый список.

Ветка форума с обсуждением скрипта: https://forummikrotik.ru/viewtopic.php?t=11586

Используете скрипт - отметьте это звездочкой, Вам не сложно, а мне приятно!
